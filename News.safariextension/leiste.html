<!DOCTYPE html>
<html>
	<head>
		<title>Leiste</title>
		<meta charset="utf-8" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="audience" content="Alle" />
		<meta http-equiv="content-language" content="de" />
		<style type="text/css">
			* {
				padding: 0;
				margin: 0;
				font-family: sans-serif;
				text-shadow: none !important;
			}

			.display {
				display: table;
				width: 100%;
				height: 100%;
				position: absolute;
				text-align: left;
				-webkit-transition: 0.62s all;
			}

			.content {
				display: table-cell;
				vertical-align: middle;
				padding-left: 5px;
				text-align: center;
				font-size: 12px;
				font-weight: 400;
			}
		</style>
		<script type="text/javascript">
			var messages = [];
			var currIndex = 0;

			function process() {
				window.devicePixelRatio = window.devicePixelRatio || 1;
				
				reload(function() {
					loop();
					setInterval(loop, 9200);
					setInterval(update, 1000 * 60 * 10);
				});
			}
			
			function reload(callback) {
				var xml = new XMLHttpRequest();
				xml.open("GET", "http://aseider.pf-control.de/newsAPI/", true);
				xml.setRequestHeader('User-Agent', 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/602.2.14 (KHTML, like Gecko) Version/10.0.1 NewsBar/602.2.14');
				xml.onreadystatechange = function() {
					if (xml.readyState == 4) {
						var ret = JSON.parse(xml.response);

						messages = ret;
						
						for (var i in messages) {
							var message = messages[i];
							message.date = new Date(message.date);
						}
						
						messages.sort(function(a, b) {
							return b.date.getTime() - a.date.getTime();
						});
						
						callback();
					}
				};
				
				xml.onprogress = function(e) {
					console.dir(e.loaded);
				};

				xml.send();
			}
			
			function getIconSrc(iconInfo) {
				if (window.devicePixelRatio == 2) {
					return iconInfo.url2;
				}
				
				return iconInfo.url;
			}
			
			function getTimeString(date) {
				var delta = (new Date).getTime() - date.getTime();
				var secs = (delta / 1000).toFixed(0);
				
				if (secs < 60) {
					return secs + " s";
				}
				
				var min = (secs / 60).toFixed(0);
				
				if (min < 60) {
					return min + " min";
				}
				
				var hours = (min / 60).toFixed(0);
				
				if (hours < 24) {
					return hours + " std";
				}
				
				var days = (hours / 24).toFixed(0);
				
				return days + " t";
			}

			function loop() {
				currIndex = ++currIndex % messages.length;
				var newMessage = messages[currIndex];
				var newDisplay = document.createElement("div");
				newDisplay.className = "display";
				newDisplay.style.top = "100%";

				var newContent = document.createElement("div");
				newContent.className = "content";
				
				var iconInformation = newMessage.icon;
				var icon = document.createElement("img");
				icon.src = getIconSrc(iconInformation);
				icon.width = iconInformation.width;
				icon.height = iconInformation.height;
				icon.alt = iconInformation.alt;
				icon.title = iconInformation.alt;
				icon.style.verticalAlign = "-8%";
				icon.style.opacity = 0.7;
				
				var time = document.createElement("i");
				time.appendChild(document.createTextNode("\t(" + getTimeString(newMessage.date) + ")"));
				time.style.color = "gray";
				
				newContent.appendChild(icon);
				newContent.appendChild(document.createTextNode("\t" + newMessage.title));
				newContent.appendChild(time);

				newDisplay.appendChild(newContent);

				document.body.appendChild(newDisplay);

				setTimeout(function() {
					document.getElementsByClassName("display")[0].style.top = "-100%";
					newDisplay.style.top = "0";

					setTimeout(function() {
						document.body.removeChild(document.getElementsByClassName("display")[0]);
					}, 620);
				}, 0);
			}
			
			function update() {
				reload(function() {
					
				});
			}

			function clicked() {
				safari.application.activeBrowserWindow.openTab().url = messages[currIndex].url;
			}
		</script>
	</head>
	<body onload="process()" onclick="clicked()">
		<div class="display">
			<div class="content">l√§dt Mitteilungen...</div>
		</div>
	</body>
</html>
